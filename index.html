<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Versatile PyScript Canvas for Scientific Computing</title>

    <style>
        body { font-family: sans-serif; margin: 2em; }
        #controls, #status-area, #output-area { margin-bottom: 1.5em; padding: 1em; border: 1px solid #ccc; border-radius: 5px; }
        #controls button { margin-left: 1em; }
        #progress-bar { width: 100%; }
        #error-display { color: red; font-weight: bold; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/mini-coi@0.0.5/dist/mini-coi.js" scope="./"></script>

    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <py-config src="./pyscript.toml"></py-config>

    <script src="./js/bridge.js"></script>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

</head>
<body>
    <h1>Versatile PyScript Canvas</h1>
    <p>A robust template for running Python simulations and data analysis in the browser.</p>

    <div id="controls">
        <label for="file-input">Upload Data File (.csv):</label>
        <input type="file" id="file-input" accept=".csv">
        <button id="run-button">Run Analysis</button>
    </div>

    <div id="status-area">
        <p id="status-message">Application ready. Please upload a file and click "Run Analysis".</p>
        <progress id="progress-bar" value="0" max="1" style="display:none;"></progress>
    </div>

    <div id="output-area">
        <div id="plot-output"></div>
        <div id="table-output"></div>
    </div>

    <div id="cvd-simulation" style="margin-top: 2em; padding: 1em; border: 1px solid #ccc; border-radius: 5px;">
        <h2>Advanced CVD Process Simulator</h2>
        <p>Select a parameter to lock, then adjust the other sliders to see how the system responds.</p>

        <div id="lock-controls" style="margin-bottom: 1em; padding: 0.5em; border: 1px solid #ddd; border-radius: 5px;">
            <strong>Lock Parameter:</strong>
            <label style="margin-left: 1em;"><input type="radio" name="locked_param" value="c2h2_pp" checked> C₂H₂ Partial Pressure</label>
            <label style="margin-left: 1em;"><input type="radio" name="locked_param" value="c2h2_flow"> C₂H₂ Flow</label>
            <label style="margin-left: 1em;"><input type="radio" name="locked_param" value="ar_flow"> Ar Flow</label>
            <label style="margin-left: 1em;"><input type="radio" name="locked_param" value="total_pressure"> Total Pressure</label>
        </div>

        <style>
            .param-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5em; }
            .param-slider label { font-weight: bold; }
        </style>
        <div id="param-controls" class="param-grid">
            <div class="param-slider">
                <label for="c2h2-flow-slider">C₂H₂ Flow (sccm)</label><br>
                <input type="range" id="c2h2-flow-slider" min="0.1" max="50" value="10" step="0.1" style="width: 80%;">
                <span id="c2h2-flow-value">10.0</span>
            </div>
            <div class="param-slider">
                <label for="ar-flow-slider">Ar Flow (sccm)</label><br>
                <input type="range" id="ar-flow-slider" min="0" max="200" value="50" step="1" style="width: 80%;">
                <span id="ar-flow-value">50</span>
            </div>
            <div class="param-slider">
                <label for="total-pressure-slider">Total Pressure (mbar)</label><br>
                <input type="range" id="total-pressure-slider" min="0.1" max="10" value="1.5" step="0.05" style="width: 80%;">
                <span id="total-pressure-value">1.50</span>
            </div>
            <div class="param-slider">
                <label for="contaminant-pp-slider">Contaminant P.P. (mbar)</label><br>
                <input type="range" id="contaminant-pp-slider" min="0.001" max="0.1" value="0.006" step="0.001" style="width: 80%;">
                <span id="contaminant-pp-value">0.006</span>
            </div>
        </div>

        <div id="output-display" style="margin-top: 1.5em; padding: 1em; background-color: #f0f8ff; border-radius: 5px; font-size: 1.2em; text-align: center;">
            <strong>Calculated C₂H₂ Partial Pressure: </strong>
            <input type="number" id="c2h2-pp-input" value="0.250" step="0.01" style="width: 80px; font-size: 1em;"> mbar
        </div>

        <div id="simulation-plot" style="margin-top: 1em;"></div>
    </div>

    <div id="error-display"></div>

    <py-script src="./src/main.py"></py-script>

    <py-script>
import js
from pyscript import Element
import pandas as pd
import plotly.express as px
import warnings

# Suppress potential FutureWarnings from pandas/plotly
warnings.simplefilter(action='ignore', category=FutureWarning)

class CVDState:
    """Manages the state and calculations for the CVD simulator."""
    def __init__(self):
        self.elements = {
            'c2h2_flow_slider': Element('c2h2-flow-slider'),
            'c2h2_flow_value': Element('c2h2-flow-value'),
            'ar_flow_slider': Element('ar-flow-slider'),
            'ar_flow_value': Element('ar-flow-value'),
            'total_pressure_slider': Element('total-pressure-slider'),
            'total_pressure_value': Element('total-pressure-value'),
            'contaminant_pp_slider': Element('contaminant-pp-slider'),
            'contaminant_pp_value': Element('contaminant-pp-value'),
            'c2h2_pp_input': Element('c2h2-pp-input'),
            'plot_div': Element('simulation-plot')
        }
        self.locked_param = 'c2h2_pp'
        self.active_slider_id = None
        self.read_ui()

    def read_ui(self):
        """Read all values from the UI into the state object."""
        self.c2h2_flow = float(self.elements['c2h2_flow_slider'].value)
        self.ar_flow = float(self.elements['ar_flow_slider'].value)
        self.total_pressure = float(self.elements['total_pressure_slider'].value)
        self.contaminant_pp = float(self.elements['contaminant_pp_slider'].value)
        try:
            self.c2h2_pp_locked_value = float(self.elements['c2h2_pp_input'].value)
        except (ValueError, TypeError):
            self.c2h2_pp_locked_value = 0.25 # Default value

        self.locked_param = js.document.querySelector('input[name="locked_param"]:checked').value

    def update_ui(self):
        """Update all UI elements from the state object's values."""
        # Update sliders and their corresponding value displays
        self.elements['c2h2_flow_slider'].element.value = self.c2h2_flow
        self.elements['c2h2_flow_value'].write(f"{self.c2h2_flow:.1f}")

        self.elements['ar_flow_slider'].element.value = self.ar_flow
        self.elements['ar_flow_value'].write(f"{self.ar_flow:.1f}")

        self.elements['total_pressure_slider'].element.value = self.total_pressure
        self.elements['total_pressure_value'].write(f"{self.total_pressure:.2f}")

        self.elements['contaminant_pp_slider'].element.value = self.contaminant_pp
        self.elements['contaminant_pp_value'].write(f"{self.contaminant_pp:.3f}")

        # Update the calculated C2H2 partial pressure display (which is an input box)
        self.elements['c2h2_pp_input'].element.value = f"{self.c2h2_pp:.3f}"

        # Enable/disable controls based on the locked parameter
        self.elements['c2h2_pp_input'].element.disabled = (self.locked_param != 'c2h2_pp')
        self.elements['c2h2_flow_slider'].element.disabled = (self.locked_param == 'c2h2_flow')
        self.elements['ar_flow_slider'].element.disabled = (self.locked_param == 'ar_flow')
        self.elements['total_pressure_slider'].element.disabled = (self.locked_param == 'total_pressure')

    # --- Calculation Engine ---
    # The core physics equation: P_c2h2 = (F_c2h2 / (F_c2h2 + F_ar)) * (P_total - P_contaminant)

    def calculate_c2h2_pp(self):
        process_pressure = self.total_pressure - self.contaminant_pp
        total_flow = self.c2h2_flow + self.ar_flow
        if total_flow > 0 and process_pressure > 0:
            self.c2h2_pp = (self.c2h2_flow / total_flow) * process_pressure
        else:
            self.c2h2_pp = 0

    def calculate_total_pressure(self):
        if self.c2h2_flow > 0 and self.c2h2_pp_locked_value > 0:
            total_flow = self.c2h2_flow + self.ar_flow
            self.total_pressure = self.c2h2_pp_locked_value * (total_flow / self.c2h2_flow) + self.contaminant_pp
        else:
            self.total_pressure = self.contaminant_pp
        self.calculate_c2h2_pp() # Recalculate for display

    def calculate_c2h2_flow(self):
        process_pressure = self.total_pressure - self.contaminant_pp
        if self.c2h2_pp_locked_value > 0 and process_pressure > self.c2h2_pp_locked_value:
            self.c2h2_flow = (self.c2h2_pp_locked_value * self.ar_flow) / (process_pressure - self.c2h2_pp_locked_value)
        else:
            self.c2h2_flow = 0
        self.calculate_c2h2_pp()

    def calculate_ar_flow(self):
        process_pressure = self.total_pressure - self.contaminant_pp
        if self.c2h2_flow > 0 and self.c2h2_pp_locked_value > 0 and process_pressure > self.c2h2_pp_locked_value:
            self.ar_flow = self.c2h2_flow * ((process_pressure / self.c2h2_pp_locked_value) - 1)
        else:
            self.ar_flow = 0
        self.calculate_c2h2_pp()

    # --- Main Update Orchestrator ---
    def update_simulation(self, active_slider_id=None):
        self.active_slider_id = active_slider_id
        self.read_ui()

        # Determine which variable to calculate based on the locked parameter and active slider
        if self.locked_param == 'c2h2_pp':
            # If C2H2 PP is locked, any change recalculates the total pressure needed.
            self.calculate_total_pressure()
        elif self.locked_param == 'total_pressure':
            if self.active_slider_id == 'ar_flow_slider':
                self.calculate_c2h2_flow()
            else:  # Default action when moving c2h2_flow or contaminant_pp sliders
                self.calculate_ar_flow()
        elif self.locked_param == 'c2h2_flow':
            if self.active_slider_id == 'ar_flow_slider':
                self.calculate_total_pressure()
            else:  # Default action when moving total_pressure or contaminant_pp sliders
                self.calculate_ar_flow()
        elif self.locked_param == 'ar_flow':
            if self.active_slider_id == 'c2h2_flow_slider':
                self.calculate_total_pressure()
            else:  # Default action when moving total_pressure or contaminant_pp sliders
                self.calculate_c2h2_flow()

        # Always update the main output value for consistency and then update the UI
        self.calculate_c2h2_pp()
        self.update_ui()
        self.update_graph()

    def update_graph(self):
        """Generates and displays a dynamic plot of the process curve."""
        # For simplicity and clarity, the graph will always show Total Pressure vs. Ar Flow.
        # The curve itself will change based on the other parameters (locked C2H2 P.P., C2H2 flow).

        # Generate a range of Argon flows for the x-axis
        ar_min = float(self.elements['ar_flow_slider'].element.min)
        ar_max = float(self.elements['ar_flow_slider'].element.max)
        ar_range = np.linspace(ar_min, ar_max, 50)

        # Calculate the corresponding total pressure for each point in the range
        pressure_range = []
        # Use the locked partial pressure for the calculation, or the current one if it's not locked
        c2h2_pp_for_calc = self.c2h2_pp_locked_value if self.locked_param == 'c2h2_pp' else self.c2h2_pp

        for ar_val in ar_range:
            if self.c2h2_flow > 0 and c2h2_pp_for_calc > 0:
                pressure = c2h2_pp_for_calc * ((self.c2h2_flow + ar_val) / self.c2h2_flow) + self.contaminant_pp
                pressure_range.append(pressure)
            else:
                pressure_range.append(self.contaminant_pp)

        plot_df = pd.DataFrame({
            'Argon Flow (sccm)': ar_range,
            'Required Total Pressure (mbar)': pressure_range
        })

        # Create the line plot
        fig = px.line(
            plot_df,
            x='Argon Flow (sccm)',
            y='Required Total Pressure (mbar)',
            title=f"Process Curve (Locked C₂H₂ P.P. ≈ {c2h2_pp_for_calc:.3f} mbar)"
        )

        # Add a marker for the current operating point
        fig.add_scatter(
            x=[self.ar_flow],
            y=[self.total_pressure],
            mode='markers',
            marker=dict(color='red', size=12, symbol='x'),
            name='Current State'
        )

        # Update layout for clarity
        fig.update_layout(height=400)

        # Render the plot
        self.elements['plot_div'].write(fig, format='html')


# --- Initialization and Event Listeners ---
state = CVDState()

def setup_listeners():
    """Add event listeners to all interactive controls."""
    # Sliders
    for name, el in state.elements.items():
        if 'slider' in name:
            el.element.addEventListener('input', lambda event, name=name: state.update_simulation(active_slider_id=name))

    # C2H2 PP input box
    state.elements['c2h2_pp_input'].element.addEventListener('change', lambda event: state.update_simulation())

    # Radio buttons for locking parameters
    radio_buttons = js.document.querySelectorAll('input[name="locked_param"]')
    for rb in radio_buttons:
        rb.addEventListener('change', lambda event: state.update_simulation())

# Run the initial setup
setup_listeners()
state.update_simulation()
    </py-script>

</body>
</html>
